{{/*
    这个局部模板负责渲染朋友圈列表。
    它实现了横向主分类 + 动态子分类的筛选模式。
    (最终版：父类实色填充，悬停为激活状态的80%透明预演)
*/}}

{{/* 1. 从 Hugo 数据文件中获取数据 */}}
{{ $feedData := index .Site.Data "friends_feed" }}
{{ $articles := $feedData.articles }}
{{ $categories := $feedData.meta.categories }}


{{/* 2. 分类筛选按钮区域 */}}
<div class="feed-filter-container">
    {{/* 主分类栏 */}}
    <div id="feed-main-categories" class="filter-bar main-bar">
        <button class="category-btn main-btn active" data-filter-type="all" data-filter-value="all">全部</button>
        {{ range $categoryName, $category := $categories }}
            {{ if gt $category.count 0 }}
            <button class="category-btn main-btn" data-filter-type="category" data-filter-value="{{ $categoryName }}">
                {{ with $category.icon }}{{ . }}{{ end }} {{ $categoryName }}
            </button>
            {{ end }}
        {{ end }}
    </div>
    
    {{/* 子分类栏 - 默认隐藏 */}}
    <div id="feed-sub-categories" class="filter-bar sub-bar">
        {{/* 内容将由JavaScript生成 */}}
    </div>
</div>


{{/* 3. 文章列表容器 和 加载指示器 */}}
<div id="friends-feed-list" class="friends-feed-list" style="display: flex; flex-direction: column; gap: 2rem;"></div>
<div id="feed-loader" style="text-align: center; padding: 20px; display: none;">
    <p>正在加载更多...</p>
</div>


{{/* 4. 核心 JavaScript 逻辑 (此部分无改动) */}}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const allArticles = {{ $articles | jsonify | safeJS }};
    const allCategoriesData = {{ $categories | jsonify | safeJS }};
    
    const articlesContainer = document.getElementById('friends-feed-list');
    if (!Array.isArray(allArticles) || allArticles.length === 0) {
        articlesContainer.innerHTML = '<div class="post-content"><p>暂时没有动态信息。</p></div>'; return;
    }

    const mainCategoriesContainer = document.getElementById('feed-main-categories');
    const subCategoriesContainer = document.getElementById('feed-sub-categories');
    const loader = document.getElementById('feed-loader');
    
    let currentFilter = { main: 'all', sub: 'all' };
    let displayedArticles = [], articlesToDisplay = [], isLoading = false;
    const articlesPerPage = 10;

    function renderSubCategories(categoryName) {
        const categoryData = allCategoriesData[categoryName];
        if (!categoryData) {
            subCategoriesContainer.innerHTML = '';
            subCategoriesContainer.classList.remove('is-visible');
            return;
        }

        let subHTML = `<button class="category-btn sub-btn active" data-filter-type="category_all" data-filter-value="${categoryName}">全部 ${categoryName}</button>`;
        for (const sourceName in categoryData.sources) {
            const source = categoryData.sources[sourceName];
            if (source.count > 0) {
                subHTML += `<button class="category-btn sub-btn" data-filter-type="source" data-filter-value="${sourceName}">${source.icon || ''} ${sourceName}</button>`;
            }
        }
        subCategoriesContainer.innerHTML = subHTML;
        subCategoriesContainer.classList.add('is-visible');
    }

    function updateFilterUI() {
        mainCategoriesContainer.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filterValue === currentFilter.main);
        });
        if (currentFilter.main === 'all') {
            subCategoriesContainer.classList.remove('is-visible');
            subCategoriesContainer.innerHTML = '';
        } else {
            subCategoriesContainer.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filterValue === currentFilter.sub);
            });
        }
    }
    
    function filterArticles() {
        articlesContainer.innerHTML = ''; displayedArticles = [];
        if (currentFilter.main === 'all') { articlesToDisplay = allArticles; } 
        else if (currentFilter.sub === currentFilter.main) { articlesToDisplay = allArticles.filter(a => a.category === currentFilter.main); }
        else { articlesToDisplay = allArticles.filter(a => a.blog_name === currentFilter.sub); }
        if (articlesToDisplay.length === 0) { articlesContainer.innerHTML = '<div class="post-content"><p>该筛选条件下暂时没有动态。</p></div>'; }
        else { loadMoreArticles(); }
    }

    mainCategoriesContainer.addEventListener('click', e => {
        const button = e.target.closest('.category-btn'); if (!button) return;
        const value = button.dataset.filterValue;
        if (value === currentFilter.main) { if (value !== 'all') { currentFilter = { main: 'all', sub: 'all' }; } }
        else { currentFilter = { main: value, sub: value }; if (value !== 'all') { renderSubCategories(value); } }
        updateFilterUI(); filterArticles();
    });

    subCategoriesContainer.addEventListener('click', e => {
        const button = e.target.closest('.category-btn'); if (!button) return;
        const value = button.dataset.filterValue;
        if (value !== currentFilter.sub) { currentFilter.sub = value; updateFilterUI(); filterArticles(); }
    });

    const handleScroll = () => { if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 300 && !isLoading && displayedArticles.length < articlesToDisplay.length) { loadMoreArticles(); }};
    window.addEventListener('scroll', handleScroll);
    
    function createArticleHTML(article) {const d=new Date(article.published).toLocaleString('zh-CN',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});const s=article.summary.length>150?article.summary.substring(0,150)+'...':article.summary;const t=document.createElement('div');t.textContent=s;const summary=t.innerHTML;return `<article class="post-entry"><header class="entry-header"><h2 class="entry-hint-parent"><a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a></h2></header><div class="entry-content"><p>${summary}</p></div><footer class="entry-footer"><span title="${article.blog_name}">${article.source_icon} ${article.blog_name}</span>&nbsp;·&nbsp;<time>${d}</time></footer></article>`;}
    function loadMoreArticles() {if(isLoading) return; isLoading = true; loader.style.display = 'block';setTimeout(() => {const s=displayedArticles.length,e=s+articlesPerPage,t=articlesToDisplay.slice(s,e);if(t.length>0){let s='';t.forEach(e=>{s+=createArticleHTML(e)}),articlesContainer.insertAdjacentHTML('beforeend',s),displayedArticles=displayedArticles.concat(t)}loader.style.display = 'none';isLoading = false;}, 300);}
    
    filterArticles();
});
</script>


{{/* 5. CSS 样式 - 最终“混合悬停”版 */}}
<style>
    /* 容器布局 */
    .feed-filter-container {
        display: flex; flex-direction: column; gap: 16px; margin-bottom: 2.5rem;
    }
    .filter-bar {
        display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    }

    /* --- 父类按钮样式 --- */
    .main-btn {
        padding: 8px 16px; border: 1px solid var(--border-color);
        background-color: var(--code-bg); color: var(--primary);
        border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 500;
        transition: all 0.15s ease-out; /* 平滑、快速的动画 */
    }

    /* 父类激活状态 (最终状态) */
    .main-btn.active {
        background-color: var(--primary); color: var(--entry); border-color: var(--primary);
        font-weight: 600; box-shadow: 0 4px 14px 0 rgba(var(--primary-rgb), 0.25);
    }
    
    /* 核心: 父类悬停预演 (激活状态的80%透明版) */
    .main-btn:hover:not(.active) {
        background-color: var(--primary); color: var(--entry); border-color: var(--primary);
        font-weight: 600; box-shadow: 0 4px 14px 0 rgba(var(--primary-rgb), 0.25);
        opacity: 0.6;
        transform: scale(1.03); /* 微小缩放 */
    }


    /* --- 子类按钮样式 --- */
    .sub-btn {
        padding: 5px 14px; border: 2px solid transparent;
        background-color: var(--code-bg); color: var(--secondary);
        border-radius: 9999px; font-size: 0.85em; font-weight: 400; cursor: pointer;
        transition: all 0.15s ease-out;
    }

    /* 子类激活状态：纯白色边框 (最终状态) */
    .sub-btn.active {
        border-color: #FFFFFF;
        color: var(--primary);
        font-weight: 500;
        background-color: var(--code-bg);
    }
    
    /* 核心: 子类悬停预演 (激活状态的80%透明版) */
    .sub-btn:hover:not(.active) {
        border-color: rgba(255, 255, 255, 0.2); /* 80%透明的白色边框 */
        color: var(--primary);
        background-color: var(--code-bg);
        transform: scale(1.03);
    }

    /* 子分类栏的显示/隐藏 */
    .sub-bar { display: none; }
    .sub-bar.is-visible { display: flex; }
</style>